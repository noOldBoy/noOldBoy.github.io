---
title: å¼‚æ­¥ä»»åŠ¡ç¼–æ’
date: 2024-07-27 06:02:52
tags:
- java
categories:
- åç«¯
cover: /images/background/li.jpeg
coverWidth: 1200
coverHeight: 320
author: ä¸äºŒ
---

CompletableFutureå¼‚æ­¥ä»»åŠ¡ç¼–æ’
<!-- more -->

#### **Callable**

çº¿ç¨‹åˆ›å»ºçš„å‡ ç§æ–¹å¼ï¼Œç»§æ‰¿`Thread`ç±»ï¼Œå®ç°`Callable`æ¥å£æˆ–`Runnable`æ¥å£ã€‚åªæœ‰`Callable`æ¥å£æ”¯æŒè¿”å›å€¼ï¼Œå¯ä»¥æ‹¿åˆ°çº¿ç¨‹çš„çŠ¶æ€ï¼Œè¿™ä¹Ÿæ˜¯çº¿ç¨‹å¼‚æ­¥ä»»åŠ¡ç¼–æ’çš„åŸºç¡€ã€‚

```java
public class CallableDemo implements Callable {

    @Override
    public String call() throws Exception {
        System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹æ‰§è¡Œæ‰§è¡Œ");
        return Thread.currentThread().getName() + "over";
    }

    public static void main(String[] args) throws ExecutionException, InterruptedException {
        CallableDemo callableDemo = new CallableDemo();
        FutureTask<CallableDemo> callableDemoFutureTask = new FutureTask<CallableDemo>(callableDemo);
        new Thread(callableDemoFutureTask).start();
        System.out.println(callableDemoFutureTask.get());
    }

}
```

è™½ç„¶å¯ä»¥æ‹¿åˆ°è¿”å›å€¼ï¼Œä½†æ˜¯è¦ä½¿ç”¨è¿™ä¸ªå»æ“ä½œçº¿ç¨‹çš„å¯åœã€‚è¿˜æ˜¯å¾ˆéº»çƒ¦çš„

#### CompletableFuture

`CompletableFuture` æ˜¯ Java 8 å¼•å…¥çš„ï¼Œç”¨äºæ”¯æŒå¼‚æ­¥ç¼–ç¨‹çš„ç±»ã€‚å®ƒå…è®¸ä½ ç¼–æ’å¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶å¤„ç†ç»“æœæˆ–å¼‚å¸¸ã€‚

`CompletableFuture`å®ç°äº†`Future`æ¥å£ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œäº†ä¸°å¯Œçš„æ‰©å±•ï¼Œå®Œç¾å¼¥è¡¥äº†`Future`çš„å±€é™æ€§ï¼Œ**åŒæ—¶`CompletableFuture`å®ç°äº†å¯¹ä»»åŠ¡ç¼–æ’çš„èƒ½åŠ›**

##### æ„é€ æ–¹æ³•

`runAsyncm`æ²¡æœ‰è¿”å›å€¼ `supplyAsync`æœ‰è¿”å›å€¼, `executor`ç”¨æ¥æŒ‡å®šçº¿ç¨‹æ± ï¼Œä¸æŒ‡å®šä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ± ã€‚

```java
public static CompletableFuture<Void> runAsync(Runnable runnable)
public static CompletableFuture<Void> runAsync(Runnable runnable, Executor executor)
public static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier)
public static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier, Executor executor)
```

##### è·å–ç»“æœ

join()å’Œget()æ–¹æ³•éƒ½æ˜¯ç”¨æ¥è·å–CompletableFutureå¼‚æ­¥ä¹‹åçš„è¿”å›å€¼ã€‚

######  å¼‚å¸¸å¤„ç†

- **`get()`**ï¼šåœ¨è·å–ç»“æœæ—¶ï¼Œå¦‚æœä»»åŠ¡ä»¥å¼‚å¸¸ç»“æŸï¼Œ`get()` ä¼šæŠ›å‡º `ExecutionException`ï¼Œéœ€è¦é¢å¤–å¤„ç†ã€‚
- **`join()`**ï¼šåœ¨è·å–ç»“æœæ—¶ï¼Œå¦‚æœä»»åŠ¡ä»¥å¼‚å¸¸ç»“æŸï¼Œ`join()` ä¼šæŠ›å‡º `CompletionException`ï¼Œæ›´ç®€å•åœ°å°è£…äº†å¼‚å¸¸ã€‚

######  é˜»å¡è¡Œä¸º

- ä¸¤è€…éƒ½å°†é˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ°ç»“æœå¯ç”¨ï¼Œä½† `get()` å¯ä»¥æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œè€Œ `join()` ä¸æ”¯æŒè¶…æ—¶

##### ç»“æœå¤„ç†

æ–¹æ³•ä¸ä»¥`Async`ç»“å°¾ï¼Œæ„å‘³ç€Actionä½¿ç”¨ç›¸åŒçš„çº¿ç¨‹æ‰§è¡Œï¼Œè€Œ`Async`å¯èƒ½ä¼šä½¿ç”¨å…¶å®ƒçš„çº¿ç¨‹å»æ‰§è¡Œ(å¦‚æœä½¿ç”¨ç›¸åŒçš„çº¿ç¨‹æ± ï¼Œä¹Ÿå¯èƒ½ä¼šè¢«åŒä¸€ä¸ªçº¿ç¨‹é€‰ä¸­æ‰§è¡Œ)ã€‚

```java
public CompletableFuture<T> whenComplete(BiConsumer<? super T,? super Throwable> action)
public CompletableFuture<T> whenCompleteAsync(BiConsumer<? super T,? super Throwable> action)
public CompletableFuture<T> whenCompleteAsync(BiConsumer<? super T,? super Throwable> action, Executor executor)
```

###### å¼‚å¸¸ç»“æœå¤„ç†

`exceptionally`ï¼šè¿”å›ä¸€ä¸ªæ–°çš„`CompletableFuture`ï¼Œå½“å‰é¢çš„`CompletableFuture`å®Œæˆæ—¶ï¼Œå®ƒä¹Ÿå®Œæˆï¼Œå½“å®ƒå¼‚å¸¸å®Œæˆæ—¶ï¼Œç»™å®šå‡½æ•°çš„å¼‚å¸¸è§¦å‘è¿™ä¸ª`CompletableFuture`çš„å®Œæˆ

##### åœºæ™¯

æƒ³èµ·äº†å°æ—¶å€™åšçš„æ•°å­¦é¢˜ï¼Œç½‘ä¸Šæ‰¾äº†ä¸€ä¸ªã€‚å°è¯•ç”¨ç¨‹åºçš„æ–¹å¼å»è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ï¼ˆæ—¶é—´ä¼šç¼©çŸ­åˆ°ç§’ï¼‰

**é¢˜ç›®ï¼š** å°æ˜ä»Šå¤©æœ‰å¾ˆå¤šå®¶åŠ¡éœ€è¦åšï¼Œä»»åŠ¡å¦‚ä¸‹ï¼š

- åšé¥­éœ€è¦ 40 åˆ†é’Ÿ
- æ´—è¡£æœéœ€è¦ 30 åˆ†é’Ÿ
- æ´—ç¢—éœ€è¦ 10 åˆ†é’Ÿï¼Œä½†å¿…é¡»åœ¨åšé¥­å®Œæˆåæ‰èƒ½è¿›è¡Œ
- æ‹–åœ°éœ€è¦ 20 åˆ†é’Ÿï¼Œä½†å¿…é¡»åœ¨æ´—è¡£æœå®Œæˆåæ‰èƒ½è¿›è¡Œ
- å–‚çŒ«éœ€è¦ 5 åˆ†é’Ÿï¼Œå¯ä»¥éšæ—¶åš

è¯·é—®å°æ˜æœ€å°‘éœ€è¦å¤šå°‘æ—¶é—´æ‰èƒ½å®Œæˆæ‰€æœ‰ä»»åŠ¡ï¼Ÿ

**ç­”ï¼š**ğŸ¤©

###### æ¨¡æ‹Ÿåœºæ™¯

```java
public class HouseholdTasks {

    // åšé¥­æ–¹æ³•ï¼Œé˜»å¡æ¨¡æ‹Ÿ
    public void cook() throws InterruptedException {
        System.out.println("å¼€å§‹åšé¥­...");
        // æ¨¡æ‹Ÿåšé¥­æ—¶é—´è¾ƒé•¿ï¼Œé˜»å¡ä¸€ä¼šå„¿ï¼Œæ¯”å¦‚4000æ¯«ç§’
        Thread.sleep(4000);
        System.out.println("åšé¥­å®Œæˆï¼");
    }

    // æ´—è¡£æœæ–¹æ³•ï¼Œé˜»å¡æ¨¡æ‹Ÿ
    public void washClothes() throws InterruptedException {
        System.out.println("å¼€å§‹æ´—è¡£æœ...");
        // æ¨¡æ‹Ÿæ´—è¡£æœæ—¶é—´è¾ƒé•¿ï¼Œé˜»å¡ä¸€ä¼šå„¿ï¼Œæ¯”å¦‚3000æ¯«ç§’
        Thread.sleep(3000);
        System.out.println("æ´—è¡£æœå®Œæˆï¼");
    }

    // æ´—ç¢—æ–¹æ³•ï¼Œä¾èµ–äºåšé¥­å®Œæˆ
    public void washDishes() throws InterruptedException {
        System.out.println("å¼€å§‹æ´—ç¢—...");
        // æ´—ç¢—ä¾èµ–äºåšé¥­å®Œæˆï¼Œé˜»å¡æ¨¡æ‹Ÿ
        Thread.sleep(1000);
        System.out.println("æ´—ç¢—å®Œæˆï¼");
    }

    // æ‹–åœ°æ–¹æ³•ï¼Œä¾èµ–äºæ´—è¡£æœå®Œæˆ
    public void mopFloor() throws InterruptedException {
        System.out.println("å¼€å§‹æ‹–åœ°...");
        // æ‹–åœ°ä¾èµ–äºæ´—è¡£æœå®Œæˆï¼Œé˜»å¡æ¨¡æ‹Ÿ
        Thread.sleep(2000);
        System.out.println("æ‹–åœ°å®Œæˆï¼");
    }

    // å–‚çŒ«æ–¹æ³•ï¼Œå¯ä»¥éšæ—¶æ‰§è¡Œ
    public void feedCat() throws InterruptedException {
        System.out.println("å¼€å§‹å–‚çŒ«...");
        // å–‚çŒ«å¯ä»¥éšæ—¶è¿›è¡Œï¼Œé˜»å¡æ¨¡æ‹Ÿ
        Thread.sleep(500);
        System.out.println("å–‚çŒ«å®Œæˆï¼");
    }
}
```



**è§£ç­”æ€è·¯ï¼š**

1. åšé¥­å’Œæ´—è¡£æœå¯ä»¥åŒæ—¶è¿›è¡Œï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰ä¾èµ–å…³ç³»ã€‚ä¸¤é¡¹åŒæ—¶è¿›è¡Œéœ€è¦ 40 åˆ†é’Ÿï¼ˆå› ä¸ºåšé¥­æ›´æ…¢ï¼‰ã€‚
2. åšé¥­ç»“æŸåï¼Œæ‰èƒ½æ´—ç¢—ï¼Œæ´—ç¢—éœ€è¦ 10 åˆ†é’Ÿã€‚
3. æ´—è¡£æœç»“æŸåï¼Œæ‰èƒ½æ‹–åœ°ï¼Œæ‹–åœ°éœ€è¦ 20 åˆ†é’Ÿã€‚
4. å–‚çŒ«å¯ä»¥éšæ—¶è¿›è¡Œï¼Œç”¨ 5 åˆ†é’Ÿå®Œæˆï¼Œä¸å½±å“å…¶ä»–ä»»åŠ¡ã€‚

**æ€»æ—¶é—´è®¡ç®—ï¼š**

- å…ˆåšé¥­å’Œæ´—è¡£æœï¼š40 åˆ†é’Ÿï¼ˆåŒæ—¶è¿›è¡Œï¼‰
- åšé¥­ç»“æŸåæ´—ç¢—ï¼š10 åˆ†é’Ÿ
- æ´—è¡£æœç»“æŸåæ‹–åœ°ï¼š20 åˆ†é’Ÿ
- å–‚çŒ«ï¼š5 åˆ†é’Ÿï¼ˆå¯ä»¥åœ¨40åˆ†é’Ÿå†…çš„ä»»æ„æ—¶åˆ»å®Œæˆï¼Œä¸å¢åŠ æ—¶é—´ï¼‰

æ‰€ä»¥ï¼Œå°æ˜æœ€å°‘éœ€è¦çš„æ—¶é—´ä¸ºï¼š**40 + 10 = 50 åˆ†é’Ÿ**ã€‚
